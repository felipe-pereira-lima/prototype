datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

// User Model (linked to a Company)
model User {
  id                Int               @id @default(autoincrement())
  company           Company           @relation(fields: [companyId], references: [id])
  companyId         Int
  competencies      Competency[]      @relation("userCompetencies")
  email             String            @unique
  employeeLevel     EmployeeLevel     @default(INTERN)
  firstName         String
  fullName          String
  givenPeerReviews  PeerReview[]      @relation("reviewer")
  givenReviews      Review[]          @relation("supervisorReviews")
  lastName          String
  meetingAttendance MeetingAttendee[]
  meetings          Meeting[]
  password          String
  peerReviews       PeerReview[]      @relation("reviewedBy")
  reviews           Review[]          @relation("employeeReviews")
  role              UserRole          @default(EMPLOYEE)
  team              Team?             @relation(fields: [teamId], references: [id])
  teamId            Int
  username          String            @unique @db.VarChar(255)
}

// Company Model
model Company {
  id          Int          @id @default(autoincrement())
  departments Department[]
  meetings    Meeting[]
  name        String
  reviews     Review[]
  teams       Team[]
  users       User[]
}

// Department Model - Represents a department within a company
model Department {
  id           Int          @id @default(autoincrement())
  company      Company      @relation(fields: [companyId], references: [id])
  companyId    Int
  competencies Competency[]
  name         String
  teams        Team[]
}

// Team Model - Represents a team within a company
model Team {
  id           Int          @id @default(autoincrement())
  company      Company      @relation(fields: [companyId], references: [id]) // Back-relation to Company
  companyId    Int
  competencies Competency[] @relation("teamCompetencies")
  department   Department   @relation(fields: [departmentId], references: [id])
  departmentId Int
  members      User[]
  name         String
}

// Competency Model - Represents a specific skill or attribute
model Competency {
  id                 Int                @id @default(autoincrement())
  department         Department         @relation(fields: [departmentId], references: [id]) // Department associated with the competency
  departmentId       Int
  description        String
  levels             CompetencyLevel[]
  name               String
  reviewCompetencies ReviewCompetency[]
  teams              Team[]             @relation("teamCompetencies")
  users              User[]             @relation("userCompetencies")
}

// CompetencyLevel Model
model CompetencyLevel {
  id                 Int                @id @default(autoincrement())
  competency         Competency         @relation(fields: [competencyId], references: [id])
  competencyId       Int
  description        String
  level              EmployeeLevel
  reviewCompetencies ReviewCompetency[]
}

// Review Model (linked to a Company)
model Review {
  id                 Int                 @id @default(autoincrement())
  careerDevelopment  CareerDevelopment?
  company            Company             @relation(fields: [companyId], references: [id])
  companyId          Int
  competencies       ReviewCompetency[]
  createdAt          DateTime            @default(now())
  developmentOutlook DevelopmentOutlook?
  employee           User                @relation("employeeReviews", fields: [employeeId], references: [id])
  employeeId         Int
  isComplete         Boolean             @default(false)
  name               String?
  reflection         Reflection?
  reviewType         ReviewType
  supervisor         User                @relation("supervisorReviews", fields: [supervisorId], references: [id])
  supervisorId       Int
  updatedAt          DateTime            @updatedAt
}

// ReviewCompetency Model
model ReviewCompetency {
  id                Int              @id @default(autoincrement())
  competency        Competency       @relation(fields: [competencyId], references: [id])
  competencyId      Int
  competencyLevel   CompetencyLevel? @relation(fields: [competencyLevelId], references: [id])
  competencyLevelId Int?
  feedbackText      String?
  review            Review           @relation(fields: [reviewId], references: [id])
  reviewId          Int
  score             Int
}

// Reflection Model
model Reflection {
  id                 Int    @id @default(autoincrement())
  employeeReflection String
  managerReflection  String
  reviewId           Int    @unique
  review             Review @relation(fields: [reviewId], references: [id])
}

// Development Outlook Model
model DevelopmentOutlook {
  id                  Int    @id @default(autoincrement())
  employeeDevelopment String
  managerDevelopment  String
  reviewId            Int    @unique
  review              Review @relation(fields: [reviewId], references: [id])
}

// Career Development Model
model CareerDevelopment {
  id                      Int    @id @default(autoincrement())
  employeeCareerGoals     String
  // TODO: managerCareerAssessment can go..., this should an employee self review
  managerCareerAssessment String
  reviewId                Int    @unique
  review                  Review @relation(fields: [reviewId], references: [id])
}

// PeerReview Model
model PeerReview {
  id              Int      @id @default(autoincrement())
  appreciatedText String
  improvementText String
  createdAt       DateTime @default(now())
  reviewedById    Int
  reviewerId      Int
  reviewer        User     @relation("reviewer", fields: [reviewerId], references: [id])
  reviewedBy      User     @relation("reviewedBy", fields: [reviewedById], references: [id])
}

// Meeting Model (linked to a Company)
model Meeting {
  id          Int               @id @default(autoincrement())
  title       String
  description String?
  scheduledAt DateTime
  companyId   Int
  company     Company           @relation(fields: [companyId], references: [id])
  createdBy   User              @relation(fields: [createdById], references: [id])
  createdById Int
  attendees   MeetingAttendee[]
}

enum UserRole {
  EMPLOYEE
  SUPERVISOR
  ADMIN
}

enum ReviewType {
  SELF_ASSESSMENT
  REVIEW
  PEER_REVIEW
}

enum EmployeeLevel {
  INTERN
  JUNIOR
  SENIOR
  MANAGER
  EXECUTIVE
  CEO
}

// Many-to-many relation for Meeting attendees
model MeetingAttendee {
  meeting   Meeting @relation(fields: [meetingId], references: [id])
  meetingId Int
  user      User    @relation(fields: [userId], references: [id])
  userId    Int

  @@id([meetingId, userId])
}
